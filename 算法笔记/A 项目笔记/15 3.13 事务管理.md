# 15 3.13 事务管理

# 事务管理
回顾
• 什么是事务
**事务**是由N步数据库操作序列组成的逻辑执行单元，这系列操作要么**全**执行，要么全放弃执行。
• 事务的特性（ACID）
`原子性（Atomicity`：事务是应用中不可再分的最小执行体。
`一致性（Consistency）`：事务执行的结果，须使数据从一个一致性状态，变为另一个一致性状态。
`隔离性（Isolation）`：各个事务的执行互不干扰，任何事务的内部操作对其他的事务都是隔离的。
`持久性（Durability）`：事务一旦提交，对数据所做的任何改变都要记录到永久存储器中。

事务的`隔离性`
• 常见的并发异常
- 第一类丢失更新、第二类丢失更新。
- **脏读**、**不可重复读**、**幻读**。
• 常见的`隔离级别`
`Read Uncommitted`：读取未提交的数据。
`Read Committed`：读取已提交的数据。
`Repeatable Read`：可重复读。
`Serializable`：串行化。
加锁，会降低性能

- 第一类丢失更新
某一个事务的回滚，导致另外一个事务已更新的数据丢失了。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210605031345247.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JpY2hhcmQyMDE4MDM=,size_16,color_FFFFFF,t_70)
- 第二类丢失更新
某一个事务的提交，导致另外一个事务已更新的数据丢失了。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210605031557791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JpY2hhcmQyMDE4MDM=,size_16,color_FFFFFF,t_70)
- 脏读
某一个事务，读取了另外一个事务未提交的数据。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210605031650468.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JpY2hhcmQyMDE4MDM=,size_16,color_FFFFFF,t_70)
- 不可重复读
某一个事务，对同一个数据前后读取的结果不一致，时间间隔太短
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210605031734661.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JpY2hhcmQyMDE4MDM=,size_16,color_FFFFFF,t_70)
- 幻读
某一个事务，对同一个表前后查询到的**行数**不一致。查询多行数据出现的问题
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210605031833266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JpY2hhcmQyMDE4MDM=,size_16,color_FFFFFF,t_70)
## 事务隔离级别
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210605031905626.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JpY2hhcmQyMDE4MDM=,size_16,color_FFFFFF,t_70)
一般用中间的两个

## 实现机制
### 悲观锁（数据库）
- 共享锁（S锁）
只能读不能改
事务A对某数据加了共享锁后，其他事务只能对该数据加共享锁，但不能加排他锁。
- 排他锁（X锁）
其他事务不能读也不能改
事务A对某数据加了排他锁后，其他事务对该数据既不能加共享锁，也不能加排他锁。


### 乐观锁（自定义）
默认没有，自己实现
- 版本号、时间戳等（识别变没变，没变就提交数据）
在更新数据前，检查版本号是否发生变化。若变化则取消本次更新，否则就更新数据（版本号+1）。

# Spring事务管理
## 声明式事务（采用这个）
控制全局
- 通过XML配置，声明某方法的事务特征。
- 通过注解，声明某方法的事务特征。
## 编程式事务
控制局部, 用于业务逻辑复杂，只想管理中间某部分的业务
- 通过 TransactionTemplate 管理事务，
并通过它执行数据库的操作。
## 演示
写在业务层

```java
 //传播机制Propagation，解决事务交叉问题
    // REQUIRED: 支持当前事务(外部事务),如果不存在则创建新事务.A调用B，对于B来说A就是当前事务
    // REQUIRES_NEW: 创建一个新事务,并且暂停当前事务(外部事务).
    // NESTED: 如果当前存在事务(外部事务),则嵌套在该事务中执行(独立的提交和回滚),否则就会REQUIRED一样.
    @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)
    public Object save1() {
        // 新增用户
        User user = new User();
        user.setUsername("alpha");
        user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
        user.setPassword(CommunityUtil.md5("123" + user.getSalt()));
        user.setEmail("alpha@qq.com");
        user.setHeaderUrl("http://image.nowcoder.com/head/99t.png");
        user.setCreateTime(new Date());
        userMapper.insertUser(user);

        // 新增帖子
        DiscussPost post = new DiscussPost();
        post.setUserId(user.getId());
        post.setTitle("Hello");
        post.setContent("新人报道!");
        post.setCreateTime(new Date());
        discussPostMapper.insertDiscussPost(post);

        Integer.valueOf("abc"); //认为造成错误 看能否回滚

        return "ok";
    }
```
新建测试类

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)
public class TransactionTests {

    @Autowired
    private AlphaService alphaService;

    @Test
    public void testSave1() {
        Object obj = alphaService.save1();
        System.out.println(obj);
    }
```


- 编程式事务演示

    @Autowired
    private TransactionTemplate transactionTemplate;
```java
 //编程事务	
    public Object save2() {
        transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
        transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

        return transactionTemplate.execute(new TransactionCallback<Object>() {
            @Override
            public Object doInTransaction(TransactionStatus status) {
                // 新增用户
                User user = new User();
                user.setUsername("beta");
                user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
                user.setPassword(CommunityUtil.md5("123" + user.getSalt()));
                user.setEmail("beta@qq.com");
                user.setHeaderUrl("http://image.nowcoder.com/head/999t.png");
                user.setCreateTime(new Date());
                userMapper.insertUser(user);

                // 新增帖子
                DiscussPost post = new DiscussPost();
                post.setUserId(user.getId());
                post.setTitle("你好");
                post.setContent("我是新人!");
                post.setCreateTime(new Date());
                discussPostMapper.insertDiscussPost(post);

                Integer.valueOf("abc");

                return "ok";
            }
        });
    }
```