# 生成验证码
java spring后台也可以画，用现成的工具
利用工具，在服务端内存画出来，然后发送给浏览器，浏览器显示在登录界面的位置。
• Kaptcha
https://code.google.com/archive/p/kaptcha/
https://code.google.com/archive/p/kaptcha/wikis/HowToUse.wiki

- 导入 jar 包
https://mvnrepository.com/artifact/com.github.penggle/kaptcha/2.3.2

```xml
<dependency>
			<groupId>com.github.penggle</groupId>
			<artifactId>kaptcha</artifactId>
			<version>2.3.2</version>
		</dependency>
```
spring boot没有对它进行配置

- 编写 Kaptcha 配置类
加载到spring容器里，spring容器对它初始化
图的大小，字数，范围颜色，干扰点线

```java
@Configuration
public class KaptchaConfig {
    //Bean 为了被spring容器装配，核心对象是一个接口叫producer
    //实例化接口就是返回这个接口Producer
    @Bean
    public Producer kaptchaProducer() {
        Properties properties = new Properties();
        properties.setProperty("kaptcha.image.width", "100");
        properties.setProperty("kaptcha.image.height", "40");
        properties.setProperty("kaptcha.textproducer.font.size", "32");
        properties.setProperty("kaptcha.textproducer.font.color", "0,0,0");
        properties.setProperty("kaptcha.textproducer.char.string", "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYAZ"); //随机字符
        properties.setProperty("kaptcha.textproducer.char.length", "4"); //长度限定
        properties.setProperty("kaptcha.noise.impl", "com.google.code.kaptcha.impl.NoNoise");  //噪声

        //实例化它的实现类
        DefaultKaptcha kaptcha = new DefaultKaptcha();
        //传入参数 可以封装到config对象里，要求传入properties， 即k-v对
        Config config = new Config(properties);
        kaptcha.setConfig(config);
        return kaptcha;
    }
```
在loginController里

```c
 //需要自己用response手动输出
    @RequestMapping(path = "/kaptcha", method = RequestMethod.GET)
    public void getKaptcha(HttpServletResponse response, HttpSession session) {
        // 生成验证码 服务端需要记住，登录的时候再访问好验证，只能存到服务器端
        String text = kaptchaProducer.createText();
        BufferedImage image = kaptchaProducer.createImage(text);

        //敏感数据存到session
        // 将验证码存入session
        session.setAttribute("kaptcha", text);

        // 将图片输出给浏览器 先声明格式
        response.setContentType("image/png");
        try {
            OutputStream os = response.getOutputStream(); //输出流
            ImageIO.write(image, "png", os); //spring帮我们关
        } catch (IOException e) {
            logger.error("响应验证码失败:" + e.getMessage());
        }
    }
```
启动服务器，打开http://localhost:8080/community/kaptcha 
就能看到验证码了 然后应用到登录页面login.html
@{/kaptcha} 将这个路径引入 然后写个js来刷新验证码

```html
<img th:src="@{/kaptcha}" style="width:100px;height:40px;" class="mr-2"/>

<a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>

	<script>
		function refresh_kaptcha() {
			// 以为图片是静态资源没有访问，需要骗浏览器以为路径变了
			var path = CONTEXT_PATH + "/kaptcha?p=" + Math.random();
			$("#kaptcha").attr("src", path);
		}
	</script>
```
- 生成随机字符、生成图
然后`在这里插入代码片`服务端需要保存下来，然后根据字符生成图片

