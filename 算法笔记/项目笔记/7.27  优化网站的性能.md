# 7.27  优化网站的性能 

![image-20210702105551918](https://gitee.com/RichardCheng_5ecf/cloudimage/raw/master/img/image-20210702105551918.png)

使用压力测试工具，感受缓存的价值！减少对数据库的直接访问

比如两个服务器1、2. 核心是service去访问数据库，app部署在服务器里, 一级本地缓存。两台服务器上的app代码一样，当用户的第一个请求分发到服务器1，应用会从缓存里找数据，如果没有分布式缓存的时候就需要直接访问DB,然后得到数据然后更新到本地缓存，数据就被返回客户端，如果第二次请求给了服务器2的时候，app从缓存取数据取不到，以为你没有登录，于是不能访问数据库。用户相关的就不能放到缓存，如果是和帖子相关的是可以的。只要数据和用户没有强关联就是可以的。Redis可以解决强关联的问题。

比如第一次访问服务器1，看本地缓存没有数据，假如我们用的是Redis, 用户看redis里有没有数据，一看没有就访问DB, 访问DB后就要把数据同步到Redis里，然后再返回给客服端。于是第二台服务器也可以访问Redis，就避免了访问DB, 所以Redis可以跨服务器，缓存各种数据。

![image-20210702112847907](https://gitee.com/RichardCheng_5ecf/cloudimage/raw/master/img/image-20210702112847907.png)

## 缓存使用过程：

假如是两级缓存

服务器里面部署APP应用，还有部分空间用于本地一级缓存，请求访问app,先看本地缓存又没，有就还回，没有就看Redis有没有，如果有就返回，没有就访问DB, 第三次访问之后就要同步到二级缓存，然后一级缓存然后返回。通常本地会设置过期时间和大小。

![image-20210702113345159](https://gitee.com/RichardCheng_5ecf/cloudimage/raw/master/img/image-20210702113345159.png)



## 优化热门贴子列表

不是按照时间排序缓存，因为经常有人发贴子，需要更新缓存。按照热门程度，需要隔一段时间几乎不变，适合缓存的是数据变化的频率较低。 

我们使用Caffeine,缓存的帖子登不登陆都可以不用。 可以单独用也可以spring整合。不建议用spring整合，因为spring用一个cache manager来管理，但是我们有很多缓存，过期时间和大小都统一的话不太合适。多个缓存管理器反而麻烦。

https://github.com/ben-manes/caffeine 手册

## 导包

```xml
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>3.0.3</version>
</dependency>

```

## 自定义参数

缓存帖子列表的时候要设置能缓存多少条数据，多长时间释放掉，好让新的数据进来。将来部署到性能好的服务器上可以调大点参数。 

缓存15个页面即可，过期时间3min。 缓存可以主动淘汰，数据变化可以淘汰，还有就是定时淘汰。我们这定时淘汰即可。例如某一个贴子发生变化了，没必要都刷新。到时间了刷新一下即可。

```xml
# caffeine
caffeine.posts.max-size=15
caffeine.posts.expire-seconds=180
```

## 优化查询方法

优化service业务方法，调用service查询的方法。



## 测试一下缓存能用

































